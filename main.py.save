from flask import Flask, render_template,request,jsonify
import time
from multiprocessing import Process
import sys


app = Flask(__name__)

')



def create_file(input_str):
	prefix_str = "import kodiebot as kb\n"+"import time\n"+"def prog():\n\t"
	input_str = input_str.replace("\n","\n\t")
	final_str = prefix_str + input_str
	file = open("kodie.py","w")
	file.write(final_str)
	

def prog_execute():
	import kodie
	kodie = reload(kodie)
	global proc
	proc = Process(target = kodie.prog)
	proc.start()

def prog_stop():
	proc.terminate()

@app.route('/')
def index():
	return render_template('index.html')

@app.route('/stop')
def stop_kodiebot():
	prog_stop()
	import RPi.GPIO as GPIO
	GPIO.cleanup()
	return jsonify("Terminated")

@app.route('/process')
def process():

	data = request.args.get('data',type=str)
	create_file(data)
	prog_execute()
	while proc.is_alive() == True:
		succ_str = "Done"
	
	proc.terminate()
	return jsonify(succ_str)



if __name__ == '__main__':
	
	app.run(host ='0.0.0.0',debug=True)
